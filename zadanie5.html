<html>
<body>

<head>
    <script>
      window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
      window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction || {READ_WRITE: "readwrite"};
      window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;

    function init(){
      var request = window.indexedDB.open("Databse5", 1);
      request.onerror = function(event) {
        alert("Can not opening database");
      };
      request.onsuccess = function(event) {
        db = event.target.result;
        db.onerror = function(event) {
          alert("Database error: " + event.target.errorCode);
        };
        updatetable();
      };

      request.onupgradeneeded = function(event) {
        var db = event.target.result;
        var objectStore = db.createObjectStore("clients", {keyPath: "id", autoIncrement: true});
        objectStore.createIndex("name", "name", {unique:false});
        objectStore.createIndex("surname", "surname", {unique:false});
        objectStore.createIndex("email", "email", {unique:false});
        objectStore.createIndex("phone", "phone", {unique:false});
        objectStore.createIndex("nip", "nip", {unique:false});
        objectStore.createIndex("idNumber", "idNumber", {unique:false});
        objectStore.createIndex("city", "city", {unique:false});
        objectStore.createIndex("street", "street", {unique:false});
        objectStore.createIndex("number", "number", {unique:false});
        objectStore.createIndex("zip", "zip", {unique:false});
        objectStore.transaction.oncomplete = function(event) {
        };
      };

      document.getElementById('addClientForm').onsubmit = function(e) {

        var data_name = document.getElementById('nameInput').value;
        var data_surname = document.getElementById('surnameInput').value;
        var data_email = document.getElementById('emailInput').value;
        var data_phone = document.getElementById('phoneInput').value;
        var data_nip = document.getElementById('nip').value;
        var data_idNumber = document.getElementById('idNumber').value;
        var data_city = document.getElementById('city').value;
        var data_street = document.getElementById('street').value;
        var data_number = document.getElementById('number').value;
        var data_zip = document.getElementById('zip').value;

        const new_data = {
          name: data_name,
          surname: data_surname,
          email: data_email,
          phone: data_phone,
          nip: data_nip,
          idNumber: data_idNumber,
          city: data_city,
          street: data_street,
          number: data_number,
          zip: data_zip
        }

        var transaction = db.transaction(["clients"], "readwrite");
        transaction.oncomplete = function(event) {
          console.log("all done with transaction");
        };
        transaction.onerror = function(event){
          console.dir(event);
        };

        var clientsObjectStore = transaction.objectStore("clients");
        var request = clientsObjectStore.add(new_data);
        request.onsuccess = function(event){
          console.log("added item");
        };

        updatetable();
      }

      function updatetable(){
        document.getElementById("clients-table-body").innerHTML = "";
        var request = db.transaction("clients").objectStore("clients").openCursor();
        request.onerror = function(event){
          console.dir(event);
        };


        request.onsuccess = function(event){
          cursor = event.target.result;
          if(cursor) {
            document.getElementById("clients-table-body").innerHTML += "<tr id=\"row+"+cursor.key+"\"><td>"  + cursor.key + "</td><td>" + cursor.value.name + "</td><td>"
              + cursor.value.surname + "</td><td>" + cursor.value.email + "</td><td>" + cursor.value.phone + "</td><td>" + cursor.value.nip + "</td><td>" + cursor.value.idNumber + "</td><td>"
              + cursor.value.city + "</td><td>" + cursor.value.street + "</td><td>" + cursor.value.number +"</td><td>" + cursor.value.zip + "</td><td><button id=\"deleteButton\" value=\"" + cursor.key + "\">Usuń</button>"
            + "</td></tr>";

            document.getElementById('deleteButton').onclick = function(e){
              var del_id = parseInt(document.getElementById('deleteButton').value);
              var request = db.transaction(["clients"], "readwrite").objectStore("clients").delete(del_id);
              document.getElementById("row"+del_id).remove();
              updateTable();
            }
            cursor.continue();
          }

        };
      }
    }

    </script>
    </head>

    <body onload="init()">


        <div style="float:left; width: 20%; display: inline-table">

          <form id="addClientForm">

                <label>Imię</label>
                <input style="display:block;"  placeholder="Wojciech" id="nameInput" required>

                <label>Nazwisko</label>
                <input  style="display:block;"  placeholder="Lesiak" id="surnameInput" required>

                <label>Email</label>
                <input style="display:block;" type="email" placeholder="wojtek.0569@gmail.com" id="emailInput" required>

                <label>Telefon</label>
                <input style="display:block;" type="phone" id="phoneInput" placeholder="111-222-333" pattern="[0-9]{3}-[0-9]{3}-[0-9]{3}$" required>

                <label>Numer nip</label>
                <input style="display:block;" type="text" id="nip" placeholder="999-999-99-99" pattern="^\d{3}[-]\d{3}[-]\d{2}[-]\d{2}$"  required>

                <label>Numer dowodu</label>
                <input style="display:block;" type="text" id="idNumber" name="idNumber" placeholder="ABC 888555" pattern="[A-Z]{3} [0-9]{6}$"  required>

                <label>Miasto</label>
                <input style="display:block;"  placeholder="Łódź" id="city" required>

                <label>Ulica</label>
                <input style="display:block;"  placeholder="Radwańska" id="street" required>

                <label>Numer budynku</label>
                <input style="display:block;" placeholder="7A" id="number" required>

                <label for="zip">Kod poczowy</label>
                <input style="display:block;" type="text" id="zip" name="zip" placeholder="97-226" pattern="^\s*?\d{2}(?:[-\s]\d{3})?\s*?$"  required>

                <button type="submit" id="addButton">Dodaj</button>

          </form>


          <div>
            <label>Szukaj</label>
            <input id="search_input"/>
            <button id="search_button">Szukaj</button>
          </div>
        </div>

        </div>


        <table id="clients-table">
            <thead>
              <tr><th>ID</th><th>Imię</th><th>Nazwisko</th><th>Email</th><th>Telefon</th><th>Nip</th><th>Numer dowodu</th><th>Miasto</th><th>Ulica</th><th>Nr budynku</th><th>Kod pocztowy</th></tr>
            </thead>
            <tbody id="clients-table-body">
            </tbody>
        </table>

    </body>
    </html>